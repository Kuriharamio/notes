# 超声波模块：

```c
#ifndef __CHAOSHENGBO_H_
#define __CHAOSHENGBO_H_

#include "main.h" 
#include "delay.h"
#include "led.h"
#include "encoder.h"

#define TRIG_ON  HAL_GPIO_WritePin(TRIG_GPIO_Port, TRIG_Pin, GPIO_PIN_SET)   //定义TRIG输出高电平
#define TRIG_OFF  HAL_GPIO_WritePin(TRIG_GPIO_Port, TRIG_Pin, GPIO_PIN_RESET)//定义TRIG输出低电平
extern TIM_HandleTypeDef htim2;//声明TIM2的HAL库结构体
extern TIM_HandleTypeDef htim1;//声明TIM3的HAL库结构体

void HAL_TIM_IC_CaptureCallback(TIM_HandleTypeDef *htim);//定时器输入捕获中断回调函数

#endif 

```



```c
#include "ultrasonic.h"
/********************************************************************************************
 *设置变量
 *distances:超声波所测距离
 *t        :回响信号脉冲持续时间
 *high_time[0]:回响信号脉冲上升沿发生时间
 *high_time[1]:回响信号脉冲下降沿发生时间
 *c_values :标志值，用于定时器输入捕获回调函数

 ********************************************************************************************/
float distances= 0 ;
uint32_t t=0;
uint32_t high_time[2]={0};
uint8_t c_values=0;



/********************************************************************************************
 * 定时器输入捕获回调函数 void HAL_TIM_IC_CaptureCallback(TIM_HandleTypeDef *htim)
 *
 *说明:
 *ECHO接收回响信号脉冲，这个回调函数要被执行2次
 *这个回调函数在类似于一个分叉路口，上升沿捕获走路口0，下降沿捕获走路口1
 *
 ********************************************************************************************/
void HAL_TIM_IC_CaptureCallback(TIM_HandleTypeDef *htim)
	{
		if(htim == &htim1)
		{
			switch(c_values)
			{//标志值c_values初始设定值为0，上升沿输入捕获，先执行回调函数执行case(0)中内容

			case(0): high_time[0]=HAL_TIM_ReadCapturedValue(&htim1,TIM_CHANNEL_1);//获取上升沿的捕获值
			         __HAL_TIM_SET_CAPTUREPOLARITY(&htim1,TIM_CHANNEL_1,TIM_ICPOLARITY_FALLING);//设置为下降沿捕获
			         c_values++;//标志值c_values值变为1，下次回调函数执行case(1)中内容
			         break;


			case(1): high_time[1]=HAL_TIM_ReadCapturedValue(&htim1,TIM_CHANNEL_1);//获取下降沿的捕获值
			         HAL_TIM_IC_Stop_IT(&htim1,TIM_CHANNEL_1); //关闭TIM2输入捕获
			         c_values=0;                 //标志值清零，用于下次输入捕获回调函数
			        __HAL_TIM_SET_COUNTER(&htim1,0);//等价于 htim1.Instance->CNT=0;      TIM1计数值清零
			         t=high_time[1]-high_time[0];//下降沿捕获值-上升沿捕获值=回响信号高电平脉冲持续时间t
				      distances= t*0.017; //速度0.034cm/us,计算出的距离要除以2,distances的单位是cm
			         break;

			default: break;

			}
			if(distances<20)
			{
				LED_ON;
			}
			else
			{
				LED_OFF;
			}

		}

	}


```

![image-20231105215438575](C:\Users\13618\AppData\Roaming\Typora\typora-user-images\image-20231105215438575.png)

## 记得打开中断

