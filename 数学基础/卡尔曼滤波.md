# 卡尔曼滤波：

## 1、概要：

- **适用系统：线性高斯系统**
  - 线性：
    - 叠加性
    - 齐次性 
  - 高斯：噪声满足正态分布
- **宏观意义**
  - 估计值与观测值的加权

## 2、基础知识：

- **状态空间表达式：**

  - **状态方程：**
    $$
    x_{k}=A{x_{k-1}}+B{u_k}+w_k
    $$
    x：状态值

    u：输入值

    w：过程噪声

    k：当前

    k-1：上一次的值

    A：状态转移矩阵

    B：控制矩阵

    

  - **观测方程：**
    $$
    y_k=Cx_k+v_k
    $$
    y：观测值

    C：某种关系矩阵

    v：观测噪声（与观测器的误差相关）

- **参数分析**

  - **高斯白噪声：**

  $$
  w_k\in N(0,Q_k)
  $$

  $$
  v_k\in N(0,R_k)
  $$

  - **方差：**

    - 一维方差：

      - 噪声的方差
        $$
        Q_k 与R_k
        $$

      - 状态（估计值）的方差
        $$
        \hat x_t^-
        $$

    - 二维方差：

      - $$
        \hat x_\overline t=
        \begin{bmatrix}
        \hat x_{t1}^-\\
        \hat x_{t2}^-\\
        \end{bmatrix}
        $$

      - $$
        \begin{flalign}
        协方差：
        \end{flalign}
        cov(\hat x_{t1}^-,\hat x_{t2}^-)=
        \begin{bmatrix}
        cov(x_1,x_1)\ \ \ \ \ cov(x_1.x_2)\\
        cov(x_2,x_1)\ \ \ \ \ cov(x_2,x_2)
        \end{bmatrix}
        $$

    - 多维方差：

  - **超参数：**

    - Q、R

  - **卡尔曼直观图解：**

    - ![image-20231202113517333](C:\Users\13618\AppData\Roaming\Typora\typora-user-images\image-20231202113517333.png)

## 3、公式理解：

- **预测（先验估计）：**
  $$
  \begin{flalign}
  \hat x_t^-&=F\hat x_{t-1}+Bu_{t-1}+w_t\\
  P_t^-&=FP_{t-1}F^T+Q\\
  F：&状态转移矩阵 \ \ \ \ \ \  B：控制矩阵 \ \ \ \ \ \  P：先验估计协方差
  \end{flalign}
  $$

- **观测：**
  $$
  z_t=Hx_t+v
  $$

- **更新：**
  $$
  \begin{flalign}
  K_t&=\frac{P_t^-H^T}{HP_t^-H^T+R}\\
  \hat x_t&=\hat x_t^-+K_t(z_t-H\hat x_t^-)\\
  P_t&=(I-K_tH)P_t^-
  \end{flalign}
  $$

  - 协方差公式：
    $$
    Cov(X,Y)=\sum p_i(X_i-\mu_X)(Y_i-\mu_Y)=E[(X-\mu_X)(Y-\mu_Y)]\\
    (p_i: 概率\ \ \ \mu_X\ \mu_Y:加权平均值)\\
    \\
    协方差矩阵：\frac{1}{m}XX^T\\
    \\
    \begin{flalign}
    Cov(x,x)&=Var(x)\\
    Cov(Ax+k,Ax+k)&=ACov(x,x)A^T
    \end{flalign}
    $$
    

- **Example：**

  - 一辆车的两个参数：p（位置）v（速度）
    $$
    x_t=
    \begin{bmatrix}
    p\\
    v
    \end{bmatrix}
    $$
    
  - **预测模型：**
    $$
    \begin{flalign}
    p_i&=p_{i-1}+v_{i-1}\Delta t+\frac{a_i}{2}\Delta t^2\\
    v_i&=v_{i-1}+a\Delta t
    \end{flalign}
    $$
    ​	得到矩阵形式：
    $$
    \begin{bmatrix}
    p_i\\
    v_i
    \end{bmatrix}
    =
    \begin{bmatrix}
    \ \ 1\ \ \ \Delta t\\
    0\ \ \ 1
    \end{bmatrix}
    \begin{bmatrix}
    p_{i-1}\\
    v_{i-1}
    \end{bmatrix}
    +
    \begin{bmatrix}
    \frac{\Delta t^2}{2}\\
    \Delta t
    \end{bmatrix}
    a_i
    $$
  
  - **观测模型：**
    $$
    z_p=&p_t+\Delta p_t\\
    z_v=&0
    $$
    ​	得到矩阵形式：
    $$
    \begin{bmatrix}
    z_p\\
    z_v
    \end{bmatrix}
    =
    \begin{bmatrix}
    \ 1\ \ \ 0\ 
    \end{bmatrix}
    \begin{bmatrix}
    p_{t}\\
    v_{t}
    \end{bmatrix}
    +
    \begin{bmatrix}
    \ 1\ \ \ 0\ 
    \end{bmatrix}
    \begin{bmatrix}
    \Delta p_{t}\\
    \Delta v_{t}
    \end{bmatrix}
    $$
  
  - **状态更新：**
  
    - 最优估计：
      $$
      \hat x_t=\hat x_t^-+K_t(z_t-H\hat x_t^-)\\
      $$
  
    - 更新卡尔曼增益：
      $$
      K_t=\frac{P_t^-H^T}{HP_t^-H^T+R}\\
      $$
  
    - 更新后验估计协方差：
      $$
      P_t=(I-K_tH)P_t^-
      $$

## 4、调节超参数：

- **Q与R的取值：**

  - 公式层面理解：

    - 一维情况下，F = H = 1，可化简为
      $$
      K=\frac{P_{t-1}+Q}{P_{t-1}+Q+R}
      $$

  - 其他层面理解：

    - Q：过程噪声方差
      - 若阻力小，运动模型基本没有过程噪声，则Q可小一点
    - R：观测过程方差
      - 观测器精度低，则R应大一点

- **初始值选取：**
  $$
  习惯取\hat x_0=0,P_0一般取1
  $$

## 5、使用：

1. 选择状态量与观测量
2. 构建方程
3. 初始化参数
4. 代入公式迭代
5. 调节超参数